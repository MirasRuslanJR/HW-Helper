<!doctype html>
<html lang="kz">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Үй тапсырмалары — Homework Helper (improved)</title>
  <meta name="description" content="Үй тапсырмаларын басқару — қарапайым және қауіпсіз" />
  <style>
    :root{
      --bg:#f4f7fb;
      --card:#ffffff;
      --muted:#6b7280;
      --primary:#0b61c3;
      --accent:#0763b8;
      --success:#16a34a;
      --danger:#ef4444;
      --border:rgba(15,23,42,0.06);
      --radius:12px;
      --max-w:1100px;
      font-family:Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:linear-gradient(180deg,var(--bg),#eef5ff);color:#0f172a}
    .wrap{max-width:var(--max-w);margin:28px auto;padding:22px;border-radius:16px;background:linear-gradient(180deg,rgba(255,255,255,0.95),var(--card));box-shadow:0 8px 30px rgba(11,97,195,0.06)}
    header{display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap}
    .brand{display:flex;align-items:center;gap:12px}
    #logo-img{width:56px;height:56px;border-radius:10px;object-fit:cover;display:block}
    h1{margin:0;font-size:18px}
    .top-actions{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .btn{padding:10px 14px;border-radius:10px;border:0;background:var(--primary);color:#fff;font-weight:600;cursor:pointer}
    .btn.ghost{background:transparent;color:var(--primary);border:1px solid rgba(11,97,195,0.12)}
    .small{font-size:13px;color:var(--muted)}
    .main{display:flex;gap:16px;margin-top:20px}
    .sidebar{background:var(--card);border-radius:12px;padding:14px;border:1px solid var(--border);box-shadow:0 6px 16px rgba(2,6,23,0.03);flex:0 0 320px}
    .search{display:flex;gap:8px;flex-direction:column}
    input.search-input{flex:1;padding:10px;border-radius:10px;border:1px solid rgba(15,23,42,0.06)}
    select.filter{padding:10px;border-radius:10px;border:1px solid rgba(15,23,42,0.06)}
    .subject-list{display:flex;flex-direction:column;gap:8px;margin-top:8px}
    .subject-item{padding:8px 10px;border-radius:8px;font-size:14px;cursor:pointer;border:1px solid transparent}
    .subject-item.active{background:linear-gradient(90deg,rgba(11,97,195,0.06),rgba(11,97,195,0.03));border-color:rgba(11,97,195,0.08);color:var(--accent)}
    .content{flex:1}
    .content-header{display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap}
    .card{background:var(--card);border-radius:12px;padding:14px;border:1px solid var(--border);box-shadow:0 6px 14px rgba(2,6,23,0.02)}
    .add-form{display:flex;flex-direction:column;gap:10px}
    input,textarea,select{width:100%;padding:10px;border-radius:10px;border:1px solid rgba(15,23,42,0.06);font-size:14px}
    textarea{min-height:90px;resize:vertical}
    .hw-list{display:flex;flex-direction:column;gap:12px;margin-top:12px}
    .hw{padding:12px;border-radius:10px;border:1px solid rgba(11,97,195,0.04);background:linear-gradient(180deg,rgba(248,252,255,0.8),#fff);display:flex;flex-direction:column}
    .hw .title{font-weight:700}
    .meta{display:flex;justify-content:space-between;align-items:center;margin-top:8px;gap:12px;flex-wrap:wrap}
    .meta > div{min-width:0}
    .meta .right{display:flex;flex-direction:column;align-items:flex-end}
    .tag{display:inline-block;padding:6px 10px;border-radius:999px;font-size:12px;background:rgba(11,97,195,0.08);color:var(--accent);margin-bottom:4px}
    .hw .desc{margin-top:8px;color:var(--muted);font-size:14px}
    .hw .author{font-size:13px;color:var(--muted)}
    .complete-btn{padding:8px 10px;border-radius:8px;border:1px solid rgba(15,23,42,0.06);cursor:pointer;background:transparent}
    .complete-btn.done{background:var(--success);color:white;border-color:rgba(0,0,0,0.05)}
    .leaderboard{margin-top:14px}
    .leaderboard .item{display:flex;justify-content:space-between;align-items:center;padding:8px 10px;border-radius:8px}
    .auth-card{max-width:520px;margin:30px auto;padding:18px;border-radius:12px;background:linear-gradient(180deg,#fff,#fbfdff);border:1px solid var(--border)}
    .hidden{display:none}
    @media (max-width:900px){
      .main{flex-direction:column}
      .sidebar{order:2;flex:0 0 auto}
      .content{order:1}
    }
    @media (max-width:480px){
      input.search-input{padding:14px;font-size:16px}
      .top-actions{gap:6px}
      .meta{flex-direction:column;align-items:flex-start}
      .meta .right{align-items:flex-start}
      .hw{padding:10px}
      #logo-img{width:48px;height:48px}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <img id="logo-img" src="./image-removebg-preview (1).png" alt="logo">
        <div>
          <h1>Үй тапсырмалары</h1>
          <div class="small">Қарапайым және ыңғайлы</div>
        </div>
      </div>
      <div class="top-actions">
        <div class="small" id="user-email"></div>
        <div class="small" id="user-points"></div>
        <button id="btn-logout" class="btn ghost hidden" onclick="logout()">Шығу</button>
        <button id="btn-show-auth" class="btn" onclick="showAuth()">Кіру / Тіркелу</button>
      </div>
    </header>

    <main id="app" class="main hidden">
      <aside class="sidebar card">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <div class="small">Іздеу</div>
            <div class="small">Тақырып, пән және дедлайн бойынша іздеңіз</div>
          </div>
          <button class="btn ghost" onclick="clearFilters()">Тазалау</button>
        </div>
        <div class="search" style="margin-top:10px">
          <input id="search" class="search-input" placeholder="Іздеу..." oninput="renderFilters()" />
          <select id="sort" class="filter" onchange="renderFilters()">
            <option value="new">Жаңадан — ескіге</option>
            <option value="old">Ескідан — жаңға</option>
            <option value="deadline">Срок бойынша</option>
          </select>
          <button id="btn-backfill" class="btn ghost hidden" onclick="backfillUserStats()">Backfill userStats</button>
        </div>

        <div style="margin-top:12px;display:flex;flex-direction:column;gap:6px">
          <div class="small">Пәндер</div>
          <div id="subject-list" class="subject-list"></div>
        </div>

        <div class="leaderboard card" style="margin-top:12px;padding:10px">
          <div class="small">Рейтинг оқушылар</div>
          <div id="leaderboard-list" style="margin-top:8px"></div>
          <div class="small" style="margin-top:8px">*Ұпай тапсырманы орындаған сайын қосылады. Тапсырма жойылса, ұпай сақталады.</div>
        </div>

        <div style="margin-top:14px" class="small">Тек админ жаңа тапсырма қоса алады.</div>
      </aside>

      <section class="content">
        <div class="content-header">
          <div>
            <h3 style="margin:0">Үй жұмыстары</h3>
            <div class="small">Барлығы — <span id="count">0</span></div>
          </div>
          <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
            <button class="btn ghost" onclick="reloadOnce()">Жаңарту</button>
            <button class="btn hidden" id="open-add" onclick="toggleAdd()">Үй жұмысын қосу</button>
          </div>
        </div>

        <div id="add-card" class="card hidden" style="margin-top:12px">
          <form class="add-form" onsubmit="event.preventDefault();addHomework();">
            <input id="hw-title" placeholder="Тақырып" />
            <select id="hw-subject">
              <option value="">Пән</option>
              <option>Ағылшын тілі</option>
              <option>Биология</option>
              <option>География</option>
              <option>Дүниежүзі тарихы</option>
              <option>Информатика</option>
              <option>Қазақ тілі мен әдебиеті</option>
              <option>Қазақстан тарихы</option>
              <option>Құқық негіздері</option>
              <option>Орыс тілі мен әдебиеті</option>
              <option>Математика</option>
              <option>Физика</option>
              <option>Химия</option>
            </select>
            <input id="hw-deadline" type="date" />
            <textarea id="hw-desc" placeholder="Сипаттама"></textarea>
            <div style="display:flex;gap:8px;justify-content:flex-end;flex-wrap:wrap">
              <div id="add-msg" class="small" style="align-self:center;color:var(--success)"></div>
              <button class="btn ghost" type="button" onclick="toggleAdd()">Болдырмау</button>
              <button class="btn" type="submit">Қосу</button>
            </div>
          </form>
        </div>

        <div id="homework-list" class="hw-list"></div>
      </section>
    </main>

    <div id="auth" class="auth-card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div>
          <h3 style="margin:0">Кіру немесе тіркелу</h3>
          <div class="small">Email және құпия сөз арқылы</div>
        </div>
      </div>
      <div style="margin-top:12px;display:flex;flex-direction:column;gap:10px">
        <input id="email" type="email" placeholder="Email" />
        <input id="password" type="password" placeholder="Құпиясөз (≥6)" />
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <button class="btn" onclick="login()">Кіру</button>
          <button class="btn ghost" onclick="register()">Тіркелу</button>
        </div>
        <div id="auth-msg" class="small" style="color:var(--danger)"></div>
      </div>
    </div>

  </div>

  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script>
    // ---- Конфигурация Firebase (оставлена как в оригинале) ----
    const firebaseConfig={apiKey:"AIzaSyAqwhaz_726NPUVhtmDI8W6Xuo4GCQNUWM",authDomain:"hw-helper-b47ca.firebaseapp.com",projectId:"hw-helper-b47ca",storageBucket:"hw-helper-b47ca.firebasestorage.app",messagingSenderId:"939392073070",appId:"1:939392073070:web:7d0a4508459ea9e586557f",measurementId:"G-2EVV90NXFS"};
    firebase.initializeApp(firebaseConfig);
    const auth=firebase.auth();
    const db=firebase.firestore();

    const el=id=>document.getElementById(id);
    let currentUser=null; let currentIsAdmin=false; let hwUnsubscribe=null; let lastSnapshot=[]; let completedMap={};
    const subjects=["Ағылшын тілі","Биология","География","Дүниежүзі тарихы","Информатика","Қазақ тілі мен әдебиеті","Қазақстан тарихы","Құқық негіздері","Математика","Орыс тілі мен әдебиеті","Физика","Химия"];

    // Helper: escape HTML
    function escapeHtml(s){return String(s||'').replace(/[&<>"]/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]))}

    // Robust date formatter supporting Firestore Timestamps and strings
    function formatDate(v){
      if(!v) return '';
      try{
        if(typeof v.toDate === 'function') v = v.toDate();
        const d = new Date(v);
        if(isNaN(d)) return String(v);
        return d.toLocaleDateString();
      } catch(e){ return String(v); }
    }

    function renderSubjectList(){
      const node=el('subject-list'); node.innerHTML='';
      const all=document.createElement('div'); all.className='subject-item active'; all.innerText='Барлығы'; all.onclick=()=>{document.querySelectorAll('.subject-item').forEach(x=>x.classList.remove('active'));all.classList.add('active');renderFilters()}; node.appendChild(all);
      subjects.forEach(s=>{const d=document.createElement('div');d.className='subject-item';d.innerText=s;d.onclick=()=>{document.querySelectorAll('.subject-item').forEach(x=>x.classList.remove('active'));d.classList.add('active');el('search').value='';renderFilters()};node.appendChild(d)})
    }
    renderSubjectList();

    auth.onAuthStateChanged(async user=>{
      try{
        currentUser=user;
        if(user){
          el('auth').classList.add('hidden'); el('app').classList.remove('hidden'); el('user-email').innerText = user.email || user.uid; el('btn-show-auth').classList.add('hidden'); el('btn-logout').classList.remove('hidden');
          currentIsAdmin = await checkAdmin(user.uid);
          if(currentIsAdmin){ el('open-add').classList.remove('hidden'); el('btn-backfill').classList.remove('hidden'); } else { el('open-add').classList.add('hidden'); el('btn-backfill').classList.add('hidden'); }
          await loadUserCompleted(user.uid);
          await ensureUserStats(user.uid);
          await renderUserPoints(user.uid);
          subscribeHomeworks();
        } else {
          el('auth').classList.remove('hidden'); el('app').classList.add('hidden'); el('user-email').innerText=''; el('user-points').innerText=''; el('btn-show-auth').classList.remove('hidden'); el('btn-logout').classList.add('hidden');
          completedMap={};
          // Keep a subscription for public homeworks view even when logged out
          subscribeHomeworks();
        }
      } catch(e){ console.error('onAuthStateChanged handler error', e); }
    });

    async function checkAdmin(uid){ try{ const doc = await db.collection('admins').doc(uid).get(); return doc.exists && doc.data().isAdmin === true }catch(e){console.error('checkAdmin',e);return false} }

    function subscribeHomeworks(){
      if(hwUnsubscribe){ hwUnsubscribe(); hwUnsubscribe = null; }
      // Keep a live snapshot for homeworks
      try{
        hwUnsubscribe = db.collection('homework').orderBy('createdAt','desc').onSnapshot(snap=>{
          lastSnapshot = snap.docs.map(d=>({id:d.id,...d.data()}));
          renderFilters(); renderLeaderboard();
        }, err=>{ console.error('homework onSnapshot error', err); });
      } catch(e){ console.error('subscribeHomeworks error', e); }
    }

    async function loadUserCompleted(uid){ completedMap={}; if(!uid) return; try{ const snap = await db.collection('userStats').doc(uid).collection('completed').get(); snap.forEach(d=>{ completedMap[d.id] = d.data(); }); }catch(e){ console.error('loadUserCompleted', e);} }

    async function ensureUserStats(uid){ if(!uid) return; const ref = db.collection('userStats').doc(uid); try{ const doc = await ref.get(); if(!doc.exists){ await ref.set({points:0,updated:firebase.firestore.FieldValue.serverTimestamp()}); } }catch(e){ console.error('ensureUserStats', e); } }

    async function renderUserPoints(uid){ if(!uid) return; try{ const doc = await db.collection('userStats').doc(uid).get(); const pts = doc.exists ? doc.data().points || 0 : 0; el('user-points').innerText = 'Ұпай: ' + pts; }catch(e){ console.error('renderUserPoints', e); } }

    // Leaderboard now shows emails explicitly (as the user requested)
    async function renderLeaderboard(){
  try{
    const lb = await db.collection('userStats').orderBy('points','desc').limit(100).get(); // limit при желании
    const node = el('leaderboard-list');
    node.innerHTML = '';
    lb.forEach(doc => {
      const data = doc.data() || {};
      const email = (data.email && String(data.email).trim()) || '';
      const display = email || (doc.id ? (doc.id.length > 8 ? doc.id.slice(0,6) + '...' : doc.id) : 'unknown');
      const pts = data.points || 0;

      const div = document.createElement('div');
      div.className = 'item';
      // если email отсутствует — добавляем подсказку/класс
      const missingBadge = email ? '' : ' <span style="font-size:11px;color:#9ca3af;margin-left:8px">(no email)</span>';
      div.innerHTML = `<div style="display:flex;gap:8px;align-items:center"><strong title="${escapeHtml(display)}">${escapeHtml(display)}</strong>${missingBadge}</div><div>${pts}</div>`;
      node.appendChild(div);
    });
  }catch(e){
    console.error('renderLeaderboard error', e);
  }
}


    function parseSearchDate(raw){
      const dateMatch = raw.match(/^\s*(\d{1,2})[.\-\/]?(\d{1,2})[.\-\/]?(\d{2,4})\s*$/);
      if(!dateMatch) return null;
      let day = Number(dateMatch[1]); let month = Number(dateMatch[2]); let year = Number(dateMatch[3]); if(year < 100) year += 2000; return new Date(year, month-1, day, 23,59,59,999);
    }

    function renderFilters(){
      const raw = el('search').value.trim();
      const q = raw.toLowerCase();
      const activeSub = document.querySelector('.subject-item.active')?.innerText || 'Барлығы';
      const sort = el('sort').value;
      let items = lastSnapshot.slice();

      if(activeSub && activeSub !== 'Барлығы'){
        items = items.filter(x => String(x.subject || '').toLowerCase() === activeSub.toLowerCase());
      }

      const parsedDate = parseSearchDate(raw);
      if(parsedDate){
        items = items.filter(x => {
          if(!x.deadline) return false;
          try{
            const d = (x.deadline && typeof x.deadline.toDate === 'function') ? x.deadline.toDate() : new Date(x.deadline);
            if(isNaN(d)) return false;
            return d <= parsedDate;
          }catch(e){ return false; }
        });
        // If sorting by deadline requested
        if(sort === 'deadline') items.sort((a,b)=>{ const da = (a.deadline && typeof a.deadline.toDate === 'function') ? a.deadline.toDate() : (a.deadline?new Date(a.deadline):new Date(8640000000000000)); const db = (b.deadline && typeof b.deadline.toDate === 'function') ? b.deadline.toDate() : (b.deadline?new Date(b.deadline):new Date(8640000000000000)); return da - db; });
        else if(sort === 'old') items.reverse();

        el('count').innerText = items.length;
        const list = el('homework-list'); list.innerHTML = '';
        if(items.length===0){ list.innerHTML = '<div class="small" style="text-align:center;color:#718096">Әзірге тапсырма жоқ.</div>'; return; }
        items.forEach(d=>{ const card=document.createElement('div'); card.className='hw'; card.innerHTML = `<div class="title">${escapeHtml(d.title||'Атауы жоқ')}</div><div class="desc">${escapeHtml(d.description||'')}</div><div class="meta"><div><span class="tag">${escapeHtml(d.subject||'Жалпы')}</span></div><div class="right"><div class="small">${escapeHtml(formatDate(d.deadline||d.createdAt||''))}</div><div class="author">${escapeHtml(d.authorEmail||'admin')}</div></div></div>`; const btn=makeCompleteButton(d.id,d); card.appendChild(btn); list.appendChild(card);});
        return;
      }

      if(q){ items = items.filter(x => (((x.title||'') + ' ' + (x.description||'') + ' ' + (x.authorEmail||'')).toLowerCase().includes(q))); }

      if(sort === 'deadline'){
        items.sort((a,b)=>{
          const da = (a.deadline && typeof a.deadline.toDate === 'function') ? a.deadline.toDate() : (a.deadline?new Date(a.deadline):new Date(8640000000000000));
          const db = (b.deadline && typeof b.deadline.toDate === 'function') ? b.deadline.toDate() : (b.deadline?new Date(b.deadline):new Date(8640000000000000));
          return da - db;
        });
      } else {
        // sort by createdAt explicitly
        items.sort((a,b)=>{
          const da = (a.createdAt && typeof a.createdAt.toDate === 'function') ? a.createdAt.toDate() : (a.createdAt?new Date(a.createdAt):new Date(0));
          const db = (b.createdAt && typeof b.createdAt.toDate === 'function') ? b.createdAt.toDate() : (b.createdAt?new Date(b.createdAt):new Date(0));
          return db - da; // default: new -> old
        });
        if(sort === 'old') items.reverse();
      }

      el('count').innerText = items.length; const list=el('homework-list'); list.innerHTML = '';
      if(items.length===0){ list.innerHTML = '<div class="small" style="text-align:center;color:#718096">Әзірге тапсырма жоқ.</div>'; return; }
      items.forEach(d=>{ const card=document.createElement('div'); card.className='hw'; card.innerHTML = `<div class="title">${escapeHtml(d.title||'Атауы жоқ')}</div><div class="desc">${escapeHtml(d.description||'')}</div><div class="meta"><div><span class="tag">${escapeHtml(d.subject||'Жалпы')}</span></div><div class="right"><div class="small">${escapeHtml(formatDate(d.deadline||d.createdAt||''))}</div><div class="author">${escapeHtml(d.authorEmail||'admin')}</div></div></div>`; const btn=makeCompleteButton(d.id,d); card.appendChild(btn); list.appendChild(card); });
    }

    function makeCompleteButton(hwId, hwData){
      const btn=document.createElement('button'); btn.className='complete-btn'; btn.type='button';
      const done = completedMap && completedMap[hwId];
      if(done) { btn.classList.add('done'); btn.innerText='Орындадым ✓'; } else { btn.innerText='Орындадым'; }
      btn.onclick = async ()=>{
        if(!currentUser){ alert('Кіру қажет'); return; }
        btn.disabled = true;
        try{
          const uid=currentUser.uid; const statRef=db.collection('userStats').doc(uid); const compRef=statRef.collection('completed').doc(hwId);
          const compDoc = await compRef.get();
          if(compDoc.exists){
            await db.runTransaction(async tx=>{
              tx.delete(compRef);
              tx.set(statRef, {points: firebase.firestore.FieldValue.increment(-1), updated: firebase.firestore.FieldValue.serverTimestamp()}, {merge:true});
            });
            delete completedMap[hwId]; btn.classList.remove('done'); btn.innerText='Орындадым';
          } else {
            await db.runTransaction(async tx=>{
              tx.set(compRef, {hwId:hwId,title:hwData.title||'',subject:hwData.subject||'',deadline:hwData.deadline||'',completedAt:firebase.firestore.FieldValue.serverTimestamp(),points:1});
              tx.set(statRef, {points: firebase.firestore.FieldValue.increment(1), email: currentUser.email||'', displayName: currentUser.email||'' , updated: firebase.firestore.FieldValue.serverTimestamp()},{merge:true});
            });
            completedMap[hwId] = {hwId,title:hwData.title||'',subject:hwData.subject||'',deadline:hwData.deadline||'',points:1}; btn.classList.add('done'); btn.innerText='Орындадым ✓';
          }
          await renderUserPoints(currentUser.uid); renderLeaderboard();
        }catch(e){ console.error('complete toggle error', e); alert('Қате: '+(e.message||e)); } finally{ btn.disabled=false; }
      };
      return btn;
    }

    async function register(){ el('auth-msg').innerText=''; const email=el('email').value.trim(); const password=el('password').value; if(!email||password.length<6){el('auth-msg').innerText='Email мен 6 таңбадан кем емес пароль енгізіңіз.';return} try{ const uc = await auth.createUserWithEmailAndPassword(email,password); await db.collection('users').doc(uc.user.uid).set({email:email,created:Date.now()}); await db.collection('userStats').doc(uc.user.uid).set({points:0,email:email,displayName:email.split('@')[0]},{merge:true}); }catch(err){ console.error('register error', err); el('auth-msg').innerText = err.message }
    }
    async function login(){ el('auth-msg').innerText=''; const email=el('email').value.trim(); const password=el('password').value; if(!email||!password){el('auth-msg').innerText='Email мен құпия сөзді енгізіңіз.';return} try{ await auth.signInWithEmailAndPassword(email,password); }catch(err){ console.error('login error', err); el('auth-msg').innerText = err.message } }
    function logout(){ auth.signOut(); }

    async function addHomework(){ if(!currentUser){alert('Кіру қажет');return} if(!currentIsAdmin){alert('Тек әкімші қоса алады');return} const title=el('hw-title').value.trim(); const desc=el('hw-desc').value.trim(); const deadline=el('hw-deadline').value||''; const subject=el('hw-subject').value||''; if(!title){el('add-msg').innerText='Тақырыпты енгізіңіз.';return} el('add-msg').innerText='Сақталып жатыр...'; try{ await db.collection('homework').add({title,description:desc,deadline,subject,authorUid:currentUser.uid,authorEmail:currentUser.email||'',createdAt:firebase.firestore.FieldValue.serverTimestamp()}); el('add-msg').innerText='Қосылды!'; el('hw-title').value=''; el('hw-desc').value=''; el('hw-deadline').value=''; setTimeout(()=>el('add-msg').innerText='',1500); }catch(e){ console.error('addHomework error', e); el('add-msg').innerText='Қате' } }

    function reloadOnce(){ if(hwUnsubscribe){ hwUnsubscribe(); hwUnsubscribe=null } subscribeHomeworks(); }
    function toggleAdd(){ el('add-card').classList.toggle('hidden') }
    function clearFilters(){ el('search').value=''; document.querySelectorAll('.subject-item').forEach(x=>x.classList.remove('active')); const first = document.querySelector('#subject-list .subject-item'); if(first) first.classList.add('active'); el('sort').value='new'; renderFilters() }
    function showAuth(){ el('auth').scrollIntoView({behavior:'smooth'}) }

    async function backfillUserStatsFromUsers({ batchSize = 400 } = {}) {
  if (!currentIsAdmin) {
    alert('Только админ может запускать backfill в браузере.');
    return;
  }

  const statsRef = db.collection('userStats');
  try {
    const snap = await statsRef.get();
    if (!snap || snap.empty) {
      alert('userStats пуста.');
      return;
    }

    let batch = db.batch();
    let processed = 0;
    let updated = 0;
    const missing = []; // uid, для которых не удалось взять email из users

    // Проходим все userStats
    for (const doc of snap.docs) {
      processed++;
      const uid = doc.id;
      const sdata = doc.data() || {};
      // если уже есть email — пропускаем
      if (sdata.email && String(sdata.email).trim()) continue;

      // пробуем взять user doc
      let email = null;
      let displayName = null;
      try {
        const udoc = await db.collection('users').doc(uid).get();
        if (udoc.exists) {
          const udata = udoc.data() || {};
          if (udata.email) email = String(udata.email).trim();
          if (udata.displayName) displayName = String(udata.displayName).trim();
        }
      } catch (e) {
        // ошибка доступа или другого рода — пропускаем и помечаем
        console.warn('users fetch fail for', uid, e && e.message ? e.message : e);
      }

      if (email) {
        const ref = statsRef.doc(uid);
        const payload = { email, displayName: displayName || (email.split ? email.split('@')[0] : '') };
        batch.set(ref, payload, { merge: true });
        updated++;
      } else {
        missing.push(uid);
      }

      // коммит батча
      if (processed % batchSize === 0) {
        await batch.commit();
        batch = db.batch();
        console.log(`Committed batch at ${processed} items`);
      }
    }

    // финальный коммит
    await batch.commit();

    const msg = `Backfill completed. Processed: ${processed}. Updated: ${updated}. Missing: ${missing.length}.`;
    console.log(msg);
    if (missing.length) {
      console.warn('UIDs without user record or permission to read them (sample):', missing.slice(0,50));
      alert(msg + `\nUID без user (проверь вручную): ${missing.slice(0,20).join(', ')}`);
    } else {
      alert(msg + '\nВсе userStats теперь содержат email.');
    }

    // Обновляем рейтинг в UI
    if (typeof renderLeaderboard === 'function') renderLeaderboard();
  } catch (err) {
    console.error('Backfill failed:', err);
    alert('Backfill қатесі: ' + (err && err.message ? err.message : err));
  }
}

// Удобная обёртка — запускает backfill и выводит прогресс минимально
async function startBackfill() {
  if (!confirm('Запустить backfill userStats из коллекции users? (выполнять только под админом)')) return;
  await backfillUserStatsFromUsers();
}


    // Initial subscription
    subscribeHomeworks();
  </script>
</body>
</html>